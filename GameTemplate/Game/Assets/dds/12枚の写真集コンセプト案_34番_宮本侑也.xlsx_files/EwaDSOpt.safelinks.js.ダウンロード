'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[62],{1522:function(u,C,a){a.r(C);var c=a(36),b=a(149),f=a(6);u=a(0);var e=a(15),d=a(88);class h{constructor(B,D,I,S,J,L){this.PolicyCookie=this.WebAffinitizedUrl=this.IsSafeLinksEnabled=null;this.PolicyCookieTTL=0;this.WasServiceDown=!1;this.AffinitizedUrl=null;this.IsSafeLinksEnabled=B;this.WebAffinitizedUrl=D;this.PolicyCookie=I;this.PolicyCookieTTL=S;this.WasServiceDown=J;this.AffinitizedUrl=L}}Object(u.a)(h,
"SafeLinksData",null,[]);class l{constructor(B,D){this.fHc=B;this.stopwatch=D}}Object(u.a)(l,"SafeLinksGetUrlReputationRequestData",null,[]);var k=a(43),n=a(41);class v{constructor(B,D,I,S){this.Ta=B;this.lh=D;this.xHg=I;v.gi=S}tra(B,D,I){try{var S=null;v.gi&&(S=v.gi.qd("WebServiceCall","SafeLinksGetUrlReputation"));const J=new l(D,S);S={};S.AffinitizedUrl=B;S.TargetUrl=D;S.PolicyCookie=I;const L=k.c(S);this.lh.Fn(this.xHg,2,L,null,!1,2,Object(d.a)(this,this.Z6i,"onGetUrlReputationSuccessCallback"),
Object(d.a)(this,this.Y6i,"onGetUrlReputationFailureCallback"),J,void 0,void 0,3E3,3E3,"36");return!0}catch(J){e.ULS.sendTraceTag(588788033,378,10,J.message)}return!1}Z6i(B){let D="OnGetUrlReputationSuccessCallback: ",I=10;const S=B.data.state;try{const J=k.b(B.data.Fe).reputationResults[0],L=J.navigateUrl.length,R=S.fHc.length,Y=J.navigateUrl===S.fHc;J.navigateUrl&&0<J.navigateUrl.length&&(S.fHc=J.navigateUrl);D+=String.format("HttpStatus {0}, verdict {1}, clickedUrlLength = {2} navigateUrlLength {3}, navigateUrlSameAsClickedUrl {4}",
B.data.httpStatus,J.verdict,R.toString(),L.toString(),Y.toString());I=50}catch(J){D+=String.format("Exception {0}",J.message)}this.Fhf(S,D,I)}Y6i(B){let D="OnGetUrlReputationFailureCallback: ";const I=B.data.state;try{D+=String.format("HttpStatus {0}",B.data.httpStatus)}catch(S){D+=String.format("Exception {0}",S.message)}this.Fhf(I,D,10)}Fhf(B,D,I){B.stopwatch&&(B.stopwatch.stop(),B.stopwatch=null);e.ULS.sendTraceTag(588788034,378,I,D);n.a.Jf(B.fHc,void 0,"noopener,noreferrer","SafeLinksNav")}}v.gi=
null;Object(u.a)(v,"SafeLinksNavigationHelper",null,[]);var x;(function(B){B[B.enabledByPolicy=0]="enabledByPolicy";B[B.disabledByPolicy=1]="disabledByPolicy";B[B.disabled_GetPolicyFailure=2]="disabled_GetPolicyFailure";B[B.disabled_PendingGetPolicyRequest=3]="disabled_PendingGetPolicyRequest"})(x||(x={}));Object(u.b)("SafeLinksNavigationState",x);var w=a(103),r=a(147),t=a(820),A=a(264),y=a(249),z=a(714),E=a(31),G=a(185),F=a(184);class O{constructor(B,D,I,S=!1,J=null,L=null){this.MGa=this.LGa=0;this.gFb=
this.UYb=!1;this.Hta=null;this.TZa=!0;this.v1b=null;e.ULS.sendTraceTag(26019598,378,100,"Initializing SafeLinksManager.");this.Ta=B;this.lh=D;this.dsa=I;O.gi=L;this.EQg=S?this.Ta.Va("SafeLinksHandlerWebServiceBase"):this.Ta.Va("WebServiceBase");this.nQg=this.Ta.Va("SafeLinksHashedUserId");this.Hlk=this.Ta.Va("SafeLinksWorkloadIdHeaderValue");this.t_b=this.Ta.oe("SafeLinksMaxGetPolicyBootRetries",2);this.u_b=this.Ta.oe("SafeLinksMaxGetPolicyOnLinkClickRetries",1);this.yZb=this.isSafeLinksEnabledForUser();
this.xZb=this.UGi();O.zte=this.Ta.Va("UserPrincipalName")||"";O.Bse=this.Ta.Va("TenantId")||"";e.ULS.sendTraceTag(26019599,378,50,"SafeLinksManager _isEnabledForUser={0}, _isEnabledForBrowser={1}",this.yZb,this.xZb);if(this.yZb&&this.xZb){D=(B=this.Kxa())?B.IsSafeLinksEnabled.toLowerCase():"";I=this.jyd();e.ULS.sendTraceTag(36231312,378,50,"Cached values for IsSafeLinksEnabled: {0}, IsPolicyCookieExpired: {1}.",D,I);var R=!B||"unknown"===D||B.WasServiceDown||I,Y=r.a.ot();Y&&(Y.set("shouldGetSafeLinksDataFromServer",
R.toString()),Y.set("isSafeLinksEnabledCacheValue",D.toString()));J?(this.TZa=!1,J.execute(Q=>{Q.isFeatureEnabled("MsoUrlreputation",!0).then(W=>{this.TZa=W;Y.set("isUserLicensedForSafeLinks",this.TZa.toString());w.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",Y);this.TZa&&R&&this.xic(!0);return null})})):(w.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",Y),R&&this.xic(!0))}}get appName(){return this.dsa}get YKc(){return this.EQg}get userId(){return this.nQg}get Iff(){try{if(""===
O.XQc){const B={};B["X-AppName"]=this.appName;B["X-AppVersion"]=f.AFrameworkApplication.buildVersion;B.OS=this.Ta.Va("PlatformNameAndVersion")||"";const D=JSON.stringify(B);O.XQc=window.self.btoa(D)}}catch(B){e.ULS.sendTraceTag(508909765,378,10,"GetUrlReputationAdditionalProperties Error: {0}",B.message)}return O.XQc}get Vai(){const B=this.YKc?this.YKc+"/":"",D=new A.QueryStringBuilder("SafeLinksHandler.ashx");D.Kj("app",this.appName);this.Ta.ra("SafeLinksUseDebugHeader")&&D.Kj("action","debug");
this.Ta.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&D.Kj("s2satpop","1");this.Ta.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&D.Kj("s2se03","1");return String.format("{0}{1}&{2}",B,D.toString(),f.AFrameworkApplication.ej)}get ghi(){const B=this.YKc?this.YKc+"/":"",D=new A.QueryStringBuilder("SafeLinksHandler.ashx");D.Kj("app",this.appName);this.Ta.ra("SafeLinksUseDebugHeader")&&D.Kj("action","debug");this.Ta.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",
!1)&&D.Kj("s2satpop","1");this.Ta.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&D.Kj("s2saat","1");this.Ta.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&D.Kj("s2se03","1");this.Ta.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksParamUpdates",!1)&&D.Kj("sladpar",this.Iff);D.Kj("slrt","GetUrlReputation");return String.format("{0}{1}&{2}",B,D.toString(),f.AFrameworkApplication.ej)}get TXi(){O.nYc||(O.nYc=new v(this.Ta,
this.lh,this.ghi,O.gi));return O.nYc}tra(B){if(!B)return e.ULS.sendTraceTag(593367827,378,10,"SafeLinksManager.TryNavigate: Null/Empty targetUrl"),!1;var D=this.WCi(B);e.ULS.sendTraceTag(594830615,378,50,"SafeLinksManager.TryNavigate: isSupportedHyperLinkType={0},_isEnabledForUser={1},_isEnabledForBrowser={2},_isUserLicensedForSafeLinks={3}",D,this.yZb,this.xZb,this.TZa);if(!(D&&this.yZb&&this.xZb&&this.TZa))return!1;D=0;const I=({state:D}=this.rWj()).returnValue;e.ULS.sendTraceTag(595079385,378,
50,"ShouldTryUsingSafeLinksService returned NavigationState={0}",x[D]);const S=r.a.ot();S&&S.set("SafeLinksNavigationState",x[D]);w.Health.instance.recordKpiUsage("SafeLinksNavigations",0,"jpittsdirects",S);if(!I)return 2!==D&&3!==D||w.Health.instance.recordKpiFailure("SafeLinksNavigations",x[D],!1,!0,null),!1;e.ULS.sendTraceTag(26019601,378,50,"Using safelinks to navigate hyperlink");if(this.zWj())return this.jyd()?!1:this.TXi.tra(this.d_h(),B,this.Kcf());if(!this.jyd())return this.Fqg(B),!0;this.Hta=
B;e.ULS.sendTraceTag(24462627,378,50,"Refreshing the cache as policy cookie expired.");this.gFb=!1;this.xic();return!0}WCi(B){B=B.toLowerCase();const D=this.Ta.Kw("SafeLinksUnsupportedProtocols");if(D)for(let I=0;I<D.length;I++)if(B.startsWith(D[I]))return!1;return!0}xic(B=!1){var D=r.a.ot();D&&D.set("isOnBootRequest",B.toString());w.Health.instance.recordKpiUsage("SafeLinksGetPolicySuccessfulRequest",1,"jpittsdirects",D);w.Health.instance.recordKpiUsage("SafeLinksGetPolicyFailedRequest",0,"jpittsdirects",
D);D=this.rad("SafeLinksGetPolicy");this.lh.Fn(this.Vai,1,null,null,!0,2,Object(d.a)(this,this.xdi,"getSafeLinksDataFromServer_OnSuccessCallback"),Object(d.a)(this,this.wdi,"getSafeLinksDataFromServer_OnFailureCallback"),D,void 0,void 0,void 0,void 0,"23");this.gFb=B;this.UYb=!0;B?this.LGa++:this.MGa++}xdi(B){let D=y.a.OYi,I="";try{this.UYb=this.gFb=!1;var S=B.data.state;const aa=({stopwatch:S}=this.iGc(S)).returnValue,Z=Object.assign(new F.a,{durationMs:aa});w.Health.instance.recordKpiSuccess("SafeLinksGetPolicySuccessfulRequest",
Z);e.ULS.sendTraceTag(594830614,378,50,"GetSafeLinksDataFromServer_OnSuccessCallback: HttpStatus {0}, data length {1}, Duration {2}",B.data.httpStatus,B.data.Fe.length,aa);if(B.data.httpStatus!==y.a.hK)I="Unexpected httpStatus: "+B.data.httpStatus.toString();else{S=null;try{S=k.b(B.data.Fe)}catch(fa){I="Exception:"+fa.toString()+" deserializing response";return}if(S){var J=S.IsSafeLinksEnabled;if(void 0===J||null===J||0>=J.length)I="Invalid isSafeLinksEnabledString";else{e.ULS.sendTraceTag(594830613,
378,50,"Retrieved isSafeLinksEnabledString {0}",J);var L=O.bMd(J);if(void 0===S.WebAffinitizedUrl||null===S.WebAffinitizedUrl||0>=S.WebAffinitizedUrl.length)I="Invalid WebAffinitizedUrl";else if(void 0===S.PolicyCookie||null===S.PolicyCookie||0>=S.PolicyCookie.length)I="Invalid PolicyCookie";else if(void 0===S.PolicyCookieTTL||null===S.PolicyCookieTTL)I="Invalid PolicyCookieTTL";else{var R=S.WebAffinitizedUrl,Y=S.PolicyCookie,Q=S.AffinitizedUrl,W=new Date;W.setMinutes(W.getMinutes()+(5<S.PolicyCookieTTL?
S.PolicyCookieTTL-5:0));var Ga=W.getTime(),pa=new h(J,R,Y,Ga,!1,Q);this.ncg(pa);D=B.data.httpStatus;this.Hta&&(L?(this.Fqg(this.Hta),this.MGa=this.LGa=0):(e.ULS.sendTraceTag(26019602,378,50,"SafeLinks is disabled by admin; Navigating without SafeLinks"),w.Health.instance.recordKpiFailure("SafeLinksNavigations","disabledByPolicy",!0,!0,null),n.a.jW(this.Hta)),this.Hta=null)}}}else I="Error when serializing response into SafeLinksData. SafeLinksData is null."}}catch(aa){I="GetSafeLinksDataFromServer_OnSuccessCallback: Exception:  "+
aa.toString()}finally{D!==y.a.hK&&this.Ehf(D,I)}}wdi(B){this.UYb=!1;let D=500,I="";try{let S=B.data.state;const J=({stopwatch:S}=this.iGc(S)).returnValue,L=Object.assign(new F.a,{durationMs:J});D=B.data.httpStatus;w.Health.instance.recordKpiFailure("SafeLinksGetPolicyFailedRequest","HttpStatusCode_"+D.toString(),!1,!0,L);I="Request Failed, Status="+z.a[B.data.status]+" Duration: "+J}catch(S){I="GetSafeLinksDataFromServer_OnFailureCallback Exception: "+S.toString()}finally{this.Ehf(D,I)}}Ehf(B,D=""){try{if(e.ULS.sendTraceTag(594830612,
378,10,"HandleGetPolicyRequestError: HttpStatus {0}, Error {1}",B,D),this.LGa<this.t_b&&this.MGa<this.u_b)this.xic(this.gFb);else{this.gFb=!1;e.ULS.sendTraceTag(24462656,378,10,"Exhausted all retries for SafeLinks GetPolicy call. OnBootRetries: {0}, OnClickRetries: {1}, HttpStatus: {2}, Error: {3}",this.LGa,this.MGa,B,D);D=null;const I=r.a.ot();I&&(I.set("HttpStatus",B.toString()),D=Object.assign(new F.a,{extendedProperties:I}));w.Health.instance.recordKpiFailure("SafeLinksGetPolicy1","GetPolicyRequestError",
!1,!0,D);const S=new h("false","","",0,!0,"");this.ncg(S);this.Hta&&(e.ULS.sendTraceTag(26019603,378,50,"Error occurred during at-click GetPolicy call, NavigationState = {0}","disabled_GetPolicyFailure"),w.Health.instance.recordKpiFailure("SafeLinksNavigations","disabled_GetPolicyFailure",!1,!0,null),n.a.jW(this.Hta),this.Hta=null)}}catch(I){e.ULS.sendTraceTag(594830611,378,10,"HandleGetPolicyRequestError: Exception {0}",I.toString())}}Fqg(B){const D=this.Kcf(),I=this.Vhi(),S={};S.Url=B;S.SafeLinksCookie=
D;S.CorrelationId=G.a.create().toString();S.WorkloadId=this.Hlk;S.UserAgentInfo=E.a.lva+"|"+this.appName;this.Ta.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksParamUpdates",!1)&&(S.User=O.zte,S.TenantId=O.Bse,S.AdditionalProperties=this.Iff);e.ULS.sendTraceTag(23900187,378,50,"Validating hyperlink with request correlation: {0}",S.CorrelationId);n.a.uxc(n.a.QY(4),I,S)}isSafeLinksEnabledForUser(){const B=this.Ta.Va("IsSafeLinksEnabledForUser");return B?O.bMd(B):!1}UGi(){const B=this.Ta.Kw("SafeLinksDisabledBrowsers");
if(E.a.pC){if(this.Ta.Dq("SafeLinksForTeamsIsEnabled")&&this.Ta.ra("SafeLinksForTeamsIsEnabled"))return!0;if(Array.contains(B,"Electron"))return!1}else if(Array.contains(B,E.a.lva))return!1;return"officecomhwa"===(this.Ta.Va(f.AFrameworkApplication.u$)||"").toLowerCase()?!1:!0}zWj(){return-1!==window.location.href.indexOf("&wd_slnh=1")||this.Ta.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksUseNavigationHelperForMobile",!1)&&E.a.S0?!0:E.a.pC}rWj(){let B;B=0;const D=this.Kxa(),I=D?D.IsSafeLinksEnabled:
"";if(""!==I)return D.WasServiceDown?(e.ULS.sendTraceTag(51663971,378,50,"Failed to retrieve policy data"),{returnValue:!1,state:2}):"false"===I.toLowerCase()?(e.ULS.sendTraceTag(51664E3,378,50,"SafeLinks disabled for the user"),{returnValue:!1,state:1}):{returnValue:O.bMd(I),state:B};if(this.UYb)return B=3,e.ULS.sendTraceTag(595079384,378,50,"Currently getting SafeLinks policy"),{returnValue:!1,state:B};if(this.LGa>=this.t_b||this.MGa>=this.u_b)return B=2,e.ULS.sendTraceTag(51664001,378,50,"Exhausted all retries- Failure in GetPolicy for SafeLinks ({0}/{1} boot, {2}/{3} onClick)",
this.LGa,this.t_b,this.MGa,this.u_b),{returnValue:!1,state:B};e.ULS.sendTraceTag(23900182,378,10,"Inconsistent SafeLinks state: SafeLinks cache data is null with no on boot request pending, and {0} retries left over. Perhaps LocalStorage is inaccessable.",this.t_b+this.u_b-(this.LGa+this.MGa));return{returnValue:!0,state:B}}Kcf(){const B=this.Kxa();return B?B.PolicyCookie:""}Vhi(){const B=this.Kxa();return B?B.WebAffinitizedUrl:""}d_h(){const B=this.Kxa();return B?B.AffinitizedUrl:""}l5h(){const B=
new Date;try{const D=this.Kxa();B.setTime(D?D.PolicyCookieTTL:0)}catch(D){e.ULS.sendTraceTag(24462658,378,10,"Exception occured while fetching expiration time from cache: {0}",D)}return B}jyd(){const B=this.l5h();return!!B&&B.getTime()<Date.now()}Kxa(){if(!this.v1b){const B=t.a.instance.getItem(this.userId);if(!B||""===B)return null;this.v1b=JSON.parse(B)}return this.v1b}ncg(B){if(void 0===B||null===B)throw Error.argumentNull("safeLinksData");if(void 0===B.IsSafeLinksEnabled||null===B.IsSafeLinksEnabled||
0>=B.IsSafeLinksEnabled.length)throw Error.argumentNull("safeLinksData.IsSafeLinksEnabled");this.v1b=B;B.WasServiceDown||this.Rlk(B)}Rlk(B){B=JSON.stringify(B);t.a.instance.setItem(this.userId,B)}rad(B){return void 0!==O.gi&&null!==O.gi?O.gi.qd("WebServiceCall",B):null}iGc(B){if(void 0!==B&&null!==B){const D=B.fd;B.stop();return{returnValue:D,stopwatch:null}}return{returnValue:null,stopwatch:B}}static bMd(B){return"false"!==B.toLowerCase()?!0:!1}}O.gi=null;O.nYc=null;O.Bse="";O.zte="";O.XQc="";Object(u.a)(O,
"SafeLinksManager",null,[459]);const M=B=>{switch(B){case 3:return"Word";case 2:return"PowerPoint";case 1:return"Excel";default:return"Unknown"}},P=B=>{switch(B){case 1:return"Edit";case 2:return"View";case 3:return"InstantView";default:return"Unknown"}};(()=>{Object(b.b)(c.lb,{Ux:"singleton"})(()=>new O(f.AFrameworkApplication.fa,f.AFrameworkApplication.de,String.format("{0}-{1}",M(f.AFrameworkApplication.sa.Qa.Ii),P(f.AFrameworkApplication.sa.Qa.kBa))))})()}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaDSOpt.safelinks.js.map/85a32d752830511bcbb662637bf627d9/EwaDSOpt.safelinks.js.map